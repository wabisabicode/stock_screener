<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stock Data Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1 class="mt-3">Stock Data</h1>
        <div id="status-message" class="alert alert-info mt-3">Connecting to stream...</div>
        
        <table id="stock-table" class="table table-hover table-striped caption-top">
            <caption>Live Stock Data</caption>
            <thead>
                <tr class="table-primary">
                    <th>Stock</th>
                    <th>Equity Ratio (%)</th>
                    <th>Net Debt/EBITDA</th>
                    <th>Inv/Rev MRQ (%)</th>
                    <th>Avg. Inv/Rev (%)</th>
                    <th></th>
                    <th>qRev Growth YoY (%)</th>
                    <th>avRev Growth Y (%)</th>
                    <th>MRQ Gross Mar (%)</th>
                    <th>Avg. Gross Mar Y (%)</th>
                    <th>MRQ FCF (%)</th>
                    <th>Avg. FCF Y (%)</th>
                    <th>MRQ</th>
                    <th>Remark</th>
                    <th></th>
                    <th>EV/Sale</th>
                    <th>4Y EV/Sale</th>
                    <th>EV/FCF</th>
                    <th>4Y EV/FCF</th>
                    <th>Div Yield</th>
                    <th>5Y Div Yield</th>
                    <th></th>
                    <th>Div Fwd</th>
                    <th>Payout Ratio</th>
                </tr>
            </thead>
            <tbody class="table-group-divider">
                </tbody>
        </table>
    </div>

    <script>
        // Helper function to format numbers or return a dash
        function formatNumber(value, fixed, isPercent = false) {
            if (typeof value !== 'number' || value === 0) {
                return 'â€”';
            }
            const suffix = isPercent ? '%' : '';
            return value.toFixed(fixed) + suffix;
        }

        // This function builds one complex row, just like your Jinja2 template did
        // UPDATED FUNCTION: It now handles the "error" flag
        function addRowToTable(item) {
            const tableBody = document.querySelector('#stock-table tbody');
            const newRow = tableBody.insertRow(-1);

            // Handle empty data (for blank list items)
            if (!item || Object.keys(item).length === 0) {
                newRow.insertCell(0).colSpan = 24;
                newRow.cells[0].innerHTML = '&nbsp;';
                return;
            }

            // --- NEW: Handle errors from the server ---
            if (item.error) {
                newRow.style.backgroundColor = '#f8d7da'; // Light red background for errors
                newRow.insertCell(0).textContent = item.symbol;
                const errorCell = newRow.insertCell(1);
                errorCell.textContent = item.remarks;
                errorCell.colSpan = 23; // Make the error message span the whole row
                return;
            }

            // Create all 24 cells with the correct formatting
            newRow.insertCell(0).textContent = item.symbol;
            newRow.insertCell(1).textContent = formatNumber(item.equity_ratio, 0, true);
            newRow.insertCell(2).textContent = formatNumber(item.net_debt_to_ebitda, 1);
            newRow.insertCell(3).textContent = formatNumber(item.inv_to_rev_mrq, 0, true);
            newRow.insertCell(4).textContent = formatNumber(item.av_inv_to_rev, 0, true);
            newRow.insertCell(5).textContent = ''; // Spacer
            newRow.insertCell(6).textContent = formatNumber(item.q_rev_growth, 0, true);
            newRow.insertCell(7).textContent = formatNumber(item.av_rev_growth, 0, true);
            newRow.insertCell(8).textContent = formatNumber(item.mrq_gp_margin, 0, true);
            newRow.insertCell(9).textContent = formatNumber(item.av_gp_margin, 0, true);
            newRow.insertCell(10).textContent = formatNumber(item.mrq_fcf_margin, 0, true);
            newRow.insertCell(11).textContent = formatNumber(item.av_fcf_margin, 0, true);
            newRow.insertCell(12).textContent = item.as_of_date || 'N/A';
            newRow.insertCell(13).textContent = item.remarks || '';
            newRow.insertCell(14).textContent = ''; // Spacer
            newRow.insertCell(15).textContent = formatNumber(item.ev_to_rev, 2);
            newRow.insertCell(16).textContent = formatNumber(item.av_ev_to_rev, 2);
            newRow.insertCell(17).textContent = formatNumber(item.ev_to_ttm_fcf, 2);
            newRow.insertCell(18).textContent = formatNumber(item.av_ev_to_fcf, 2);
            newRow.insertCell(19).textContent = formatNumber(item.div_yield, 2, true);
            newRow.insertCell(20).textContent = formatNumber(item.av_div_5y, 2, true);
            newRow.insertCell(21).textContent = ''; // Spacer
            newRow.insertCell(22).textContent = formatNumber(item.div_fwd, 2);
            newRow.insertCell(23).textContent = formatNumber(item.payout_ratio, 1, true);
        }

        // This is the main logic that runs when the results page loads
        document.addEventListener('DOMContentLoaded', () => {
            const statusMessage = document.getElementById('status-message');
            const urlParams = new URLSearchParams(window.location.search);
            const tickers = urlParams.get('tickers');

            if (tickers) {
                statusMessage.textContent = `Processing tickers: ${tickers}...`;
                const eventSource = new EventSource(`/stream-results?tickers=${tickers}`);

                eventSource.onmessage = function(event) {
                    if (event.data === "[DONE]") {
                        statusMessage.textContent = 'Processing complete.';
                        statusMessage.className = 'alert alert-success';
                        eventSource.close();
                        return;
                    }
                    const data = JSON.parse(event.data);
                    addRowToTable(data);
                };

                eventSource.onerror = function(err) {
                    statusMessage.textContent = 'An error occurred while streaming data.';
                    statusMessage.className = 'alert alert-danger';
                    eventSource.close();
                };
            } else {
                statusMessage.textContent = 'No tickers provided to analyze.';
                statusMessage.className = 'alert alert-warning';
            }
        });
    </script>
</body>
</html>